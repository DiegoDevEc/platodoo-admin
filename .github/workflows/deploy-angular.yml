name: Deploy Angular Frontend via Coolify API (Docker Build)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Checkout repositorio
        uses: actions/checkout@v3

      - name: üîß Reemplazar Google OAuth en environment.prod.ts
        run: |
          sed -i "s|GOOGLE_CLIENT_ID_PLACEHOLDER|${{ secrets.GOOGLE_CLIENT_ID }}|g" src/environments/environment.prod.ts
          sed -i "s|GOOGLE_CLIENT_SECRET_PLACEHOLDER|${{ secrets.GOOGLE_CLIENT_SECRET }}|g" src/environments/environment.prod.ts

      - name: ‚öôÔ∏è Instalar dependencias y compilar
        run: |
          npm ci
          npm run build -- --configuration=production

      - name: üöÄ Desplegar v√≠a Coolify
        run: |
          echo "‚è≥ Ejecutando curl a Coolify..."

          RESPONSE=$(curl -s -w "%{http_code}" -o coolify-response.log \
            -X POST "http://31.97.12.29:8000/api/v1/deploy?uuid=nc4kw8ks44gk4kswgoww8gk0&force=false" \
            -H "Authorization: Bearer ${{ secrets.COOLIFY_DEPLOY_TOKEN }}" )

          echo "üìÑ Respuesta HTTP: $RESPONSE"
          echo "üì¶ Contenido de respuesta:"
          cat coolify-response.log

          if [ "$RESPONSE" -ne 200 ] && [ "$RESPONSE" -ne 202 ]; then
            echo "‚ùå Error: Coolify devolvi√≥ c√≥digo HTTP $RESPONSE"
            exit 1
          fi

          echo "‚úÖ Despliegue disparado correctamente desde GitHub Actions."
