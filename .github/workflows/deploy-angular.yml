name: Build & Deploy Angular App to GHCR and Coolify

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Checkout repositorio
        uses: actions/checkout@v3

      - name: üîß Inyectar GOOGLE_CLIENT_ID en environment.prod.ts
        run: |
          sed -i "s|GOOGLE_CLIENT_ID_PLACEHOLDER|\"${{ secrets.GOOGLE_CLIENT_ID }}\"|g" src/environments/environment.prod.ts

      - name: ‚öôÔ∏è Instalar dependencias y compilar Angular
        run: |
          npm ci
          npm run build -- --configuration=production

      - name: üîê Login en GHCR
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin

      - name: üê≥ Build y push de imagen a GHCR
        run: |
          USERNAME_LOWER=$(echo "${{ secrets.GHCR_USERNAME }}" | tr '[:upper:]' '[:lower:]')
          IMAGE=ghcr.io/$USERNAME_LOWER/playtodoo-admin:latest
          docker build -t $IMAGE .
          docker push $IMAGE

      - name: üöÄ Notificar a Coolify para redeploy
        run: |
          curl -X POST "https://backoffice.playtodoo.com/api/v1/deploy?uuid=nc4kw8ks44gk4kswgoww8gk0&force=true" \
            -H "Authorization: Bearer ${{ secrets.COOLIFY_DEPLOY_TOKEN }}"
