name: Deploy Angular Frontend via Coolify API (Docker Build)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout repositorio
        uses: actions/checkout@v3

      - name: ğŸ”§ Reemplazar Google OAuth en environment.prod.ts
        run: |
          sed -i "s|GOOGLE_CLIENT_ID_PLACEHOLDER|${{ secrets.GOOGLE_CLIENT_ID }}|g" src/environments/environment.prod.ts

      - name: ğŸ” Verificar contenido de environment.prod.ts
        run: |
          echo "ğŸ“„ Verificando si se inyectÃ³ el GOOGLE_CLIENT_ID..."
          cat src/environments/environment.prod.ts
          echo "âœ… Fin del contenido del archivo."

      - name: âš™ï¸ Instalar dependencias y compilar
        run: |
          npm ci
          npm run build -- --configuration=production

      - name: ğŸš€ Desplegar vÃ­a Coolify
        run: |
          echo "â³ Ejecutando curl a Coolify..."

          RESPONSE=$(curl -s -w "%{http_code}" -o coolify-response.log \
            -X POST "http://31.97.12.29:8000/api/v1/deploy?uuid=nc4kw8ks44gk4kswgoww8gk0&force=false" \
            -H "Authorization: Bearer ${{ secrets.COOLIFY_DEPLOY_TOKEN }}" )

          echo "ğŸ“„ Respuesta HTTP: $RESPONSE"
          echo "ğŸ“¦ Contenido de respuesta:"
          cat coolify-response.log

          if [ "$RESPONSE" -ne 200 ] && [ "$RESPONSE" -ne 202 ]; then
            echo "âŒ Error: Coolify devolviÃ³ cÃ³digo HTTP $RESPONSE"
            exit 1
          fi

          echo "âœ… Despliegue disparado correctamente desde GitHub Actions."
